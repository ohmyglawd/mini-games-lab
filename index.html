<!doctype html>
<html lang="zh-Hant">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>å¯æ„›å°‘å¥³æ”¾ç½®éŠæˆ² v0.1</title>
    <style>
      :root {
        color-scheme: dark;
        --bg1: #1f1147;
        --bg2: #0f172a;
        --card: rgba(26, 32, 64, 0.78);
        --line: #475569;
        --text: #f8fafc;
        --soft: #cbd5e1;
        --pink: #f472b6;
        --pink2: #ec4899;
        --mint: #34d399;
      }
      * { box-sizing: border-box; }
      body {
        margin: 0;
        min-height: 100vh;
        font-family: "Noto Sans TC", Inter, system-ui, -apple-system, sans-serif;
        background: radial-gradient(circle at top, var(--bg1), var(--bg2) 60%);
        color: var(--text);
      }
      .screen {
        min-height: 100vh;
        display: none;
        align-items: center;
        justify-content: center;
        padding: 24px;
      }
      .screen.active { display: flex; }
      .panel {
        width: min(760px, 94vw);
        background: var(--card);
        border: 1px solid var(--line);
        border-radius: 22px;
        padding: 24px;
        box-shadow: 0 18px 50px rgba(0,0,0,.35);
      }
      h1, h2, p { margin: 0; }
      .title { font-size: clamp(1.7rem, 3vw, 2.2rem); margin-bottom: 12px; }
      .sub { color: var(--soft); margin-bottom: 18px; line-height: 1.6; }
      .menu-buttons, .row { display: grid; gap: 12px; }
      .menu-buttons { margin-top: 14px; }
      button {
        border: none;
        border-radius: 14px;
        padding: 12px 16px;
        font-size: 1rem;
        font-weight: 700;
        color: #071021;
        background: linear-gradient(135deg, var(--pink), var(--pink2));
        cursor: pointer;
      }
      button.alt { background: #334155; color: var(--text); }
      button.good { background: linear-gradient(135deg, #6ee7b7, var(--mint)); }
      button:disabled { opacity: .45; cursor: not-allowed; }
      .game-grid {
        display: grid;
        gap: 18px;
        grid-template-columns: 1fr;
      }
      .topbar {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        justify-content: space-between;
        align-items: center;
      }
      .stats {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }
      .chip {
        background: rgba(15, 23, 42, .88);
        border: 1px solid #334155;
        border-radius: 999px;
        padding: 8px 12px;
        font-size: .92rem;
      }
      .girl-wrap {
        position: relative;
        text-align: center;
        border: 1px dashed #64748b;
        border-radius: 18px;
        padding: 16px;
        background: rgba(15, 23, 42, .5);
        overflow: hidden;
      }
      #girlButton {
        width: min(360px, 82vw);
        background: transparent;
        border: none;
        cursor: pointer;
        transition: transform .08s ease;
        padding: 0;
        position: relative;
        z-index: 2;
      }
      #girlButton:active { transform: scale(.97); }
      .girl-svg {
        width: 100%;
        max-height: 560px;
        object-fit: contain;
        height: auto;
        filter: drop-shadow(0 12px 24px rgba(0,0,0,.35));
      }
      .girl-svg.seed { filter: drop-shadow(0 12px 24px rgba(0,0,0,.35)) saturate(0.95); }
      .girl-svg.mid { filter: drop-shadow(0 12px 24px rgba(0,0,0,.35)) saturate(1.1) contrast(1.05); }
      .girl-svg.final { filter: drop-shadow(0 12px 24px rgba(0,0,0,.35)) saturate(1.18) contrast(1.08) brightness(1.04); }
      #sparkles {
        position: absolute;
        inset: 0;
        pointer-events: none;
        z-index: 3;
      }
      .spark {
        position: absolute;
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: #fde68a;
        animation: pop 700ms ease-out forwards;
      }
      @keyframes pop {
        0% { transform: translate(0,0) scale(0.3); opacity: 1; }
        100% { transform: translate(var(--dx), var(--dy)) scale(1.1); opacity: 0; }
      }
      #stageLabel { margin-top: 6px; color: var(--soft); }
      .hint { color: var(--soft); font-size: .9rem; margin-top: 8px; }
      .toast {
        margin-top: 10px;
        color: #0f172a;
        background: #fef08a;
        border-radius: 10px;
        padding: 8px 10px;
        display: none;
      }
      .toast.show { display: inline-block; }
    </style>
  </head>
  <body>
    <section id="menuScreen" class="screen active">
      <div class="panel">
        <h1 class="title">ğŸ® å¯æ„›å°‘å¥³æ”¾ç½®éŠæˆ²</h1>
        <p class="sub">å–®æ©Ÿç‰ˆåŸå‹ï¼šæ¯åˆ†é˜è‡ªå‹• +1 åˆ†ï¼Œä¹Ÿå¯æ‰‹å‹•é»æ“Šå°‘å¥³ +1 åˆ†ã€‚</p>
        <div class="menu-buttons">
          <button id="newGameBtn" class="good">æ–°éŠæˆ²</button>
          <button id="loadGameBtn">è®€å–éŠæˆ²</button>
          <button id="exitBtn" class="alt">é€€å‡ºéŠæˆ²</button>
        </div>
        <p class="hint">æç¤ºï¼šæœƒè‡ªå‹•å­˜æª”åœ¨æœ¬æ©Ÿç€è¦½å™¨ï¼ˆlocalStorageï¼‰ã€‚</p>
        <p id="menuToast" class="toast"></p>
      </div>
    </section>

    <section id="gameScreen" class="screen">
      <div class="panel game-grid">
        <div class="topbar">
          <h2>ğŸ’– å°‘å¥³é¤Šæˆä¸­</h2>
          <div class="stats">
            <span class="chip">ç©åˆ†ï¼š<strong id="scoreText">0</strong></span>
            <span class="chip">è‡ªå‹•åŠ åˆ†ï¼šæ¯åˆ†é˜ +1</span>
          </div>
        </div>

        <div class="girl-wrap">
          <div id="sparkles"></div>
          <button id="girlButton" aria-label="é»æ“Šå°‘å¥³åŠ åˆ†"></button>
          <p id="stageLabel">åˆå§‹å‹æ…‹ï¼ˆ0~10ï¼‰</p>
          <p class="hint">é»æˆ‘ä¸€ä¸‹ +1 åˆ†</p>
        </div>

        <div class="row">
          <button id="saveBtn" class="good">æ‰‹å‹•å­˜æª”</button>
          <button id="backBtn" class="alt">è¿”å›ä¸»é¸å–®</button>
        </div>
      </div>
    </section>

    <script>
      const SAVE_KEY = "mini_games_idle_girl_save_v1";
      const AUTO_GAIN_MS = 60_000;

      const menuScreen = document.getElementById("menuScreen");
      const gameScreen = document.getElementById("gameScreen");
      const scoreText = document.getElementById("scoreText");
      const stageLabel = document.getElementById("stageLabel");
      const girlButton = document.getElementById("girlButton");
      const menuToast = document.getElementById("menuToast");
      const sparkles = document.getElementById("sparkles");

      let state = { score: 0, updatedAt: Date.now() };
      let timer = null;

      const STAGES = [
        {
          min: 0,
          max: 10,
          style: "seed",
          label: "åˆå§‹å‹æ…‹ï¼ˆ0~10ï¼‰",
          image: "./assets/mage-base.png"
        },
        {
          min: 11,
          max: 20,
          style: "mid",
          label: "ä¸­éšå‹æ…‹ï¼ˆ11~20ï¼‰",
          image: "./assets/mage-mid.png"
        },
        {
          min: 21,
          max: 30,
          style: "final",
          label: "æœ€çµ‚å‹æ…‹ï¼ˆ21~30ï¼‰",
          image: "./assets/mage-final.png"
        }
      ];

      function girlSvg(style) {
        // åŸå‰µï¼šåƒè€ƒä½ çµ¦çš„ã€Œç´«é«®æ³•å¸«å°‘å¥³ã€æ°£è³ªï¼Œåšæˆæ›´æ¥è¿‘æ—¥ç³»æ‰‹éŠç«‹ç¹ªæ„Ÿã€‚
        const hair = style === "final" ? "#7e3af2" : style === "mid" ? "#8b5cf6" : "#9f7aea";
        const robeDark = style === "final" ? "#1f2434" : style === "mid" ? "#252c3d" : "#2d3347";
        const robeLight = style === "final" ? "#f8fafc" : style === "mid" ? "#f1f5f9" : "#e2e8f0";
        const glow = style === "final" ? "#7dd3fc" : style === "mid" ? "#93c5fd" : "#bae6fd";

        return `
          <svg class="girl-svg" viewBox="0 0 320 420" xmlns="http://www.w3.org/2000/svg" role="img" aria-label="äºŒæ¬¡å…ƒç´«é«®æ³•å¸«å°‘å¥³">
            <defs>
              <radialGradient id="ringGlow" cx="50%" cy="50%" r="50%">
                <stop offset="0%" stop-color="${glow}" stop-opacity="0.45"/>
                <stop offset="100%" stop-color="#000" stop-opacity="0"/>
              </radialGradient>
              <linearGradient id="hairGrad" x1="0" x2="1">
                <stop offset="0%" stop-color="#a78bfa"/>
                <stop offset="100%" stop-color="${hair}"/>
              </linearGradient>
            </defs>

            <circle cx="230" cy="120" r="78" fill="url(#ringGlow)" opacity="0.8"/>
            <circle cx="94" cy="170" r="56" fill="url(#ringGlow)" opacity="0.45"/>
            <ellipse cx="160" cy="365" rx="92" ry="18" fill="#67e8f9" opacity="0.35"/>

            <path d="M56 156 Q138 136 204 202" stroke="#7dd3fc" stroke-width="8" fill="none" stroke-linecap="round" opacity="0.8"/>
            <path d="M220 110 Q260 130 288 180" stroke="#7dd3fc" stroke-width="6" fill="none" stroke-linecap="round" opacity="0.65"/>

            <path d="M66 206 L184 152" stroke="#6b4f3f" stroke-width="12" stroke-linecap="round"/>
            <path d="M56 214 L175 160" stroke="#7c5f4b" stroke-width="7" stroke-linecap="round"/>
            <path d="M48 213 L67 198 L70 223 Z" fill="#9a7a57"/>

            <path d="M122 124 Q110 56 171 50 Q232 56 226 138 Q218 188 180 205 Q142 210 122 124Z" fill="url(#hairGrad)"/>
            <path d="M143 110 Q181 91 211 112 Q220 140 210 174 Q186 198 154 192 Q130 170 143 110Z" fill="#fbe4d5"/>

            <ellipse cx="166" cy="146" rx="11" ry="8" fill="#6d28d9"/>
            <ellipse cx="195" cy="144" rx="11" ry="8" fill="#6d28d9"/>
            <circle cx="162" cy="143" r="2.6" fill="#fff"/>
            <circle cx="191" cy="141" r="2.6" fill="#fff"/>
            <path d="M168 166 Q180 174 192 166" stroke="#fb7185" stroke-width="3.5" fill="none" stroke-linecap="round"/>

            <path d="M122 120 Q104 147 98 183 Q112 175 125 158 Z" fill="url(#hairGrad)"/>
            <path d="M220 132 Q252 157 259 198 Q230 187 212 164 Z" fill="url(#hairGrad)"/>

            <path d="M110 207 Q163 188 212 208 L242 326 Q195 362 116 344 L104 303 Z" fill="${robeDark}"/>
            <path d="M138 218 Q167 204 197 219 L214 334 Q181 356 136 348 L129 320 Z" fill="${robeLight}"/>

            <path d="M124 221 Q110 250 103 278 Q117 272 128 255 Z" fill="#dbeafe"/>
            <path d="M211 225 Q227 247 238 278 Q219 272 203 252 Z" fill="#c7d2fe"/>

            <path d="M146 336 L160 386 L145 390 L132 342 Z" fill="#0f172a"/>
            <path d="M193 335 L206 385 L221 380 L207 338 Z" fill="#0f172a"/>
            <ellipse cx="146" cy="390" rx="15" ry="8" fill="#111827"/>
            <ellipse cx="220" cy="380" rx="15" ry="8" fill="#111827"/>

            <circle cx="119" cy="182" r="7" fill="#dbeafe"/>
            <circle cx="118" cy="182" r="3" fill="#7c3aed"/>
          </svg>`;
      }

      function showScreen(screen) {
        menuScreen.classList.remove("active");
        gameScreen.classList.remove("active");
        screen.classList.add("active");
      }

      function getStage(score) {
        if (score >= 21) return STAGES[2];
        if (score >= 11) return STAGES[1];
        return STAGES[0];
      }

      function clampScore(score) {
        return Math.max(0, Math.min(30, score));
      }

      function render() {
        state.score = clampScore(state.score);
        const stage = getStage(state.score);
        scoreText.textContent = state.score;
        stageLabel.textContent = stage.label;

        // å…ˆæ¸…ç©ºï¼Œæ”¹ç”¨ JS äº‹ä»¶è™•ç†è¼‰åœ–å¤±æ•—ï¼Œé¿å… inline onerror å­—ä¸²è½‰ç¾©å•é¡Œã€‚
        girlButton.innerHTML = "";

        const fallbackSvg = girlSvg(stage.style);
        const img = document.createElement("img");
        img.className = `girl-svg ${stage.style}`;
        img.src = stage.image;
        img.alt = "ç´«é«®æ³•å¸«é¢¨å°‘å¥³ç«‹ç¹ª";
        img.loading = "eager";
        img.referrerPolicy = "no-referrer";

        img.addEventListener("error", () => {
          girlButton.innerHTML = fallbackSvg;
        });

        girlButton.appendChild(img);
      }

      function saveGame(showMsg = false) {
        state.updatedAt = Date.now();
        localStorage.setItem(SAVE_KEY, JSON.stringify(state));
        if (showMsg) toast("å·²å­˜æª” âœ¨");
      }

      function loadGame() {
        const raw = localStorage.getItem(SAVE_KEY);
        if (!raw) return null;
        try {
          const parsed = JSON.parse(raw);
          if (typeof parsed.score !== "number") return null;
          return {
            score: clampScore(parsed.score),
            updatedAt: typeof parsed.updatedAt === "number" ? parsed.updatedAt : Date.now()
          };
        } catch {
          return null;
        }
      }

      function applyOfflineGain() {
        const now = Date.now();
        const elapsed = now - state.updatedAt;
        if (elapsed <= 0) return;
        const gain = Math.floor(elapsed / AUTO_GAIN_MS);
        if (gain > 0) state.score = clampScore(state.score + gain);
        state.updatedAt = now;
      }

      function startGameLoop() {
        stopGameLoop();
        timer = setInterval(() => {
          state.score = clampScore(state.score + 1);
          render();
          saveGame(false);
        }, AUTO_GAIN_MS);
      }

      function stopGameLoop() {
        if (timer) {
          clearInterval(timer);
          timer = null;
        }
      }

      function toast(msg) {
        menuToast.textContent = msg;
        menuToast.classList.add("show");
        clearTimeout(toast._t);
        toast._t = setTimeout(() => menuToast.classList.remove("show"), 1800);
      }

      function burstSparkles() {
        const colors = ["#fde68a", "#ddd6fe", "#f9a8d4", "#93c5fd"];
        for (let i = 0; i < 9; i++) {
          const s = document.createElement("span");
          s.className = "spark";
          s.style.left = `${45 + Math.random() * 10}%`;
          s.style.top = `${45 + Math.random() * 10}%`;
          s.style.setProperty("--dx", `${(Math.random() - 0.5) * 110}px`);
          s.style.setProperty("--dy", `${(Math.random() - 0.5) * 120}px`);
          s.style.background = colors[Math.floor(Math.random() * colors.length)];
          sparkles.appendChild(s);
          setTimeout(() => s.remove(), 720);
        }
      }

      function enterGame(fromLoad = false) {
        if (fromLoad) applyOfflineGain();
        render();
        showScreen(gameScreen);
        startGameLoop();
      }

      document.getElementById("newGameBtn").addEventListener("click", () => {
        state = { score: 0, updatedAt: Date.now() };
        saveGame(false);
        document.getElementById("loadGameBtn").disabled = false;
        enterGame(false);
      });

      document.getElementById("loadGameBtn").addEventListener("click", () => {
        const loaded = loadGame();
        if (!loaded) {
          toast("æ‰¾ä¸åˆ°å­˜æª”ï¼Œè«‹å…ˆå»ºç«‹æ–°éŠæˆ²ï½");
          return;
        }
        state = loaded;
        enterGame(true);
      });

      document.getElementById("exitBtn").addEventListener("click", () => {
        toast("å·²é€€å‡ºï¼ˆç›®å‰ç¶²é ç‰ˆç„¡æ³•ç›´æ¥é—œé–‰åˆ†é ï¼‰");
      });

      girlButton.addEventListener("click", () => {
        state.score = clampScore(state.score + 1);
        render();
        burstSparkles();
        saveGame(false);
      });

      document.getElementById("saveBtn").addEventListener("click", () => saveGame(true));

      document.getElementById("backBtn").addEventListener("click", () => {
        saveGame(false);
        stopGameLoop();
        showScreen(menuScreen);
      });

      // åˆå§‹ UI
      render();
      if (!loadGame()) {
        document.getElementById("loadGameBtn").disabled = true;
      }
      window.addEventListener("beforeunload", () => saveGame(false));
    </script>
  </body>
</html>
